<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MITA BETTING - MASTER ADMIN</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #002d4b; --accent: #ff8c00; --danger: #c62828; --success: #2e7d32; --info: #1976d2; }
        body { margin: 0; background: #f0f2f5; font-family: 'Segoe UI', sans-serif; padding-bottom: 50px; }
        
        .header { background: #8B4513; color: white; padding: 20px; text-align: center; font-weight: 900; border-bottom: 5px solid #000; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        
        .section { background: white; margin: 12px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .section-title { background: var(--primary); color: white; padding: 12px; font-size: 14px; font-weight: 900; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; background: #fff; }
        .stat-box { background: #f8f9fa; border: 2px solid var(--primary); padding: 10px; text-align: center; border-radius: 10px; }
        .stat-val { font-size: 20px; font-weight: 900; color: var(--accent); display: block; }
        .stat-label { font-size: 11px; color: #666; font-weight: 700; text-transform: uppercase; }

        .card { padding: 15px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 10px; }
        .card-info { font-size: 13px; font-weight: 700; color: #333; line-height: 1.6; }
        
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        button { padding: 10px 12px; border: none; border-radius: 6px; font-weight: 900; font-size: 11px; cursor: pointer; color: white; transition: 0.2s; text-transform: uppercase; }
        button:active { transform: scale(0.95); }
        .btn-approve { background: var(--success); }
        .btn-reject { background: var(--danger); }
        .btn-reset { background: var(--accent); }
        .btn-edit { background: var(--info); }
        .btn-del { background: #000; }

        .search-box { padding: 10px 15px; background: #eee; border-bottom: 1px solid #ddd; }
        .search-box input { width: 100%; padding: 10px; border-radius: 6px; border: 2px solid var(--primary); box-sizing: border-box; font-weight: 700; }

        .num-input { width: 85px; padding: 5px; border: 2px solid var(--primary); font-weight: 900; font-size: 14px; border-radius: 4px; text-align: center; }
        
        #history-list, #user-list { max-height: 400px; overflow-y: auto; font-size: 12px; }
        .history-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        
        .btn-clear-all { background: var(--danger); width: calc(100% - 24px); margin: 12px; padding: 18px; font-weight: 900; border-radius: 10px; font-size: 15px; }
        .badge { background: #eee; padding: 2px 8px; border-radius: 10px; font-size: 10px; margin-left: 5px; color: #000; }
        .pass-text { color: var(--danger); font-family: monospace; font-size: 14px; background: #fff5f5; padding: 2px 5px; border-radius: 4px; }
    </style>
</head>
<body>

<div class="header"><i class="fas fa-user-shield"></i> MITA BETTING - FULL CONTROL</div>

<div class="section">
    <div class="section-title"><span><i class="fas fa-chart-line"></i> Dashboard Stats</span></div>
    <div class="stat-grid">
        <div class="stat-box"><span class="stat-label">Play 1 (50)</span><span id="s-play1" class="stat-val">0</span></div>
        <div class="stat-box"><span class="stat-label">Play 2 (100)</span><span id="s-play2" class="stat-val">0</span></div>
        <div class="stat-box"><span class="stat-label">Play 3 (200)</span><span id="s-play3" class="stat-val">0</span></div>
        <div class="stat-box"><span class="stat-label">Active Users</span><span id="s-users" class="stat-val">0</span></div>
    </div>
</div>

<div class="section">
    <div class="section-title"><span><i class="fas fa-wallet"></i> Deposit Requests</span><span id="dep-count" class="badge">0</span></div>
    <div id="deposit-list"></div>
</div>

<div class="section">
    <div class="section-title"><span><i class="fas fa-money-bill-wave"></i> Withdraw Requests</span><span id="wit-count" class="badge">0</span></div>
    <div id="withdraw-list"></div>
</div>

<div class="section">
    <div class="section-title"><span><i class="fas fa-key"></i> Pass Reset Requests</span><span id="pass-count" class="badge">0</span></div>
    <div id="pass-requests"></div>
</div>

<div class="section">
    <div class="section-title"><span><i class="fas fa-users"></i> User Management</span></div>
    <div class="search-box"><input type="text" id="user-search" placeholder="Search by name or phone..." oninput="filterUsers()"></div>
    <div id="user-list"></div>
</div>

<div class="section">
    <div class="section-title"><span><i class="fas fa-history"></i> Recent Activity</span></div>
    <div id="history-list"></div>
</div>

<button class="btn-clear-all" onclick="clearAllData()">WIPE ALL HISTORY & ROUNDS</button>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCOrYzcTRXTX50Aqhz4GoVjpptrmh4BKu0",
        authDomain: "bekas-fast2.firebaseapp.com",
        databaseURL: "https://bekas-fast2-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "bekas-fast2",
        storageBucket: "bekas-fast2.firebasestorage.app",
        messagingSenderId: "267970590270",
        appId: "1:267970590270:web:dd4adbda56d4e27aaf036f"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- AUTO APPROVAL LOGIC (TELEBIRR) ---
    database.ref('incoming_sms').on('child_added', (smsSnap) => {
        const smsData = smsSnap.val();
        const smsText = smsData.message;

        database.ref('deposit_requests').once('value', (depSnap) => {
            depSnap.forEach((depChild) => {
                const depRequest = depChild.val();
                const txCode = depRequest.transactionCode.trim();
                const formattedAmount = "ETB " + parseFloat(depRequest.amount).toFixed(2);

                if (smsText.includes(txCode) && smsText.includes(formattedAmount)) {
                    approveDep(depChild.key, depRequest.phone, depRequest.amount);
                    database.ref('incoming_sms/' + smsSnap.key).remove();
                }
            });
        });
    });

    // --- DEPOSITS ---
    database.ref('deposit_requests').on('value', snap => {
        const list = document.getElementById('deposit-list'); 
        document.getElementById('dep-count').innerText = snap.numChildren();
        list.innerHTML = "";
        snap.forEach(c => {
            const d = c.val();
            list.innerHTML += `<div class="card">
                <div class="card-info"><b>PHONE:</b> ${d.phone}<br><b>AMOUNT:</b> ${d.amount} ETB<br><b>TX CODE:</b> ${d.transactionCode}</div>
                <div class="btn-group">
                    <button class="btn-approve" onclick="approveDep('${c.key}', '${d.phone}', ${d.amount})">APPROVE ‚úÖ</button>
                    <button class="btn-reject" onclick="rem('deposit_requests', '${c.key}')">REJECT ‚ùå</button>
                </div>
            </div>`;
        });
    });

    function approveDep(key, ph, amt) {
        database.ref('users/' + ph + '/balance').transaction(c => (c || 0) + parseFloat(amt))
        .then(() => { log(ph, "Deposit Approved", amt); rem('deposit_requests', key); });
    }

    // --- WITHDRAWALS ---
    database.ref('withdraw_requests').on('value', snap => {
        const list = document.getElementById('withdraw-list');
        document.getElementById('wit-count').innerText = snap.numChildren();
        list.innerHTML = "";
        snap.forEach(c => {
            const w = c.val();
            list.innerHTML += `<div class="card">
                <div class="card-info"><b>PHONE:</b> ${w.phone}<br><b>AMOUNT:</b> ${w.amount} ETB</div>
                <div class="btn-group">
                    <button class="btn-approve" onclick="rem('withdraw_requests', '${c.key}')">PAID ‚úÖ</button>
                    <button class="btn-reject" onclick="refund('${c.key}', '${w.phone}', ${w.amount})">REFUND üîô</button>
                </div>
            </div>`;
        });
    });

    function refund(key, ph, amt) {
        database.ref('users/' + ph + '/balance').transaction(c => (c || 0) + parseFloat(amt))
        .then(() => { log(ph, "Refund Issued", amt); rem('withdraw_requests', key); });
    }

    // --- PASSWORD REQUESTS ---
    database.ref('password_requests').on('value', snap => {
        const list = document.getElementById('pass-requests');
        document.getElementById('pass-count').innerText = snap.numChildren();
        list.innerHTML = "";
        snap.forEach(c => {
            list.innerHTML += `<div class="card"><div class="card-info"><b>RESET REQ:</b> ${c.val().phone}</div>
            <button class="btn-reject" onclick="rem('password_requests', '${c.key}')">MARK DONE</button></div>`;
        });
    });

    // --- USER MANAGEMENT ---
    let allUsers = [];
    database.ref('users').on('value', snap => {
        document.getElementById('s-users').innerText = snap.numChildren();
        allUsers = [];
        snap.forEach(c => { allUsers.push({key: c.key, ...c.val()}); });
        renderUsers(allUsers);
    });

    function renderUsers(users) {
        const list = document.getElementById('user-list'); list.innerHTML = "";
        users.forEach(u => {
            const userPhone = u.key;
            list.innerHTML += `<div class="card">
                <div class="card-info">
                    <b>NAME:</b> ${u.username || 'N/A'}<br>
                    <b>PHONE:</b> <span style="color:#002d4b; font-weight:900;">${userPhone}</span><br>
                    <b>PASSWORD:</b> <span class="pass-text">${u.password || '****'}</span><br>
                    <b>BALANCE:</b> ${(u.balance || 0).toFixed(2)} ETB
                </div>
                <div class="row" style="margin-top:8px; display:flex; gap:5px; align-items:center;">
                    <input type="number" id="amt-${userPhone}" placeholder="Amt" class="num-input">
                    <button class="btn-approve" style="background:#28a745; padding: 8px 12px;" onclick="adjustBal('${userPhone}', 'add')">+</button>
                    <button class="btn-reject" style="background:#dc3545; padding: 8px 12px;" onclick="adjustBal('${userPhone}', 'sub')">-</button>
                    <button class="btn-del" style="margin-left:auto;" onclick="delUser('${userPhone}')">DEL</button>
                </div>
            </div>`;
        });
    }

    function adjustBal(phone, type) {
        const el = document.getElementById('amt-' + phone);
        const v = parseFloat(el.value);
        if (isNaN(v)) return;
        database.ref('users/' + phone + '/balance').transaction(c => (c || 0) + (type === 'add' ? v : -v)).then(() => {
            log(phone, type === 'add' ? 'Admin Add' : 'Admin Sub', v);
            el.value = "";
        });
    }

    function filterUsers() {
        const q = document.getElementById('user-search').value.toLowerCase();
        const filtered = allUsers.filter(u => u.key.includes(q) || (u.username && u.username.toLowerCase().includes(q)));
        renderUsers(filtered);
    }

    function delUser(key) { if(confirm("DELETE USER?")) database.ref('users/' + key).remove(); }
    function log(phone, type, amount) { database.ref('transaction_history').push({ phone, type, amount, time: new Date().toLocaleString() }); }
    function rem(path, key) { database.ref(path + '/' + key).remove(); }
    
    function clearAllData() {
        if(confirm("WIPE EVERYTHING?")) {
            ['deposit_requests', 'withdraw_requests', 'transaction_history', 'games', 'password_requests'].forEach(p => database.ref(p).remove());
        }
    }

    ['play1', 'play2', 'play3'].forEach(g => {
        database.ref('games/' + g + '/selections').on('value', snap => {
            document.getElementById('s-' + g).innerText = snap.numChildren();
        });
    });

    database.ref('transaction_history').limitToLast(20).on('value', snap => {
        const list = document.getElementById('history-list'); list.innerHTML = "";
        snap.forEach(c => {
            const h = c.val();
            list.innerHTML += `<div class="history-item">
                <b>${h.phone}</b> <small>${h.type}</small> <b style="color:green">${h.amount}</b>
            </div>`;
        });
    });
</script>
</body>
</html>
